<!-- extend base layout -->
{% macro singleItemBlock(name, value, valId, width=3, extra_cls='') -%}
	<div class="well well-tny info-item">
		<div class="row singleitem"  id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
				<span class='text-nowrap'>
					<a id='editlink' href="#" onclick="edit('{{valId}}-container');return false;">[edit]</a>
					<a id='historylink' href="/history/{{valId}}/{{series.id}}">[history]</a>
				</span>
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
				<span class='singleitem {{extra_cls}}'>{{ ( value if value else "N/A" ) | safe }}</span>
			</div>
		</div>
	</div>
{%- endmacro %}

{% macro singleItemNonEditable(name, value, width=3) -%}
	<div class="well well-tny info-item">
		<div class="row">
			<div class="col-md-12">
				List Stats:
				<span style='float:right'>
					{% if not value: %}
						Not on anyone's reading list.
					{% elif value == 1: %}
						{{value}} person follows this series.
					{% elif value > 1: %}
						{{value}} people follow this series.
					{% else %}
						Wat? (On {{value}} reading lists)
					{% endif %}

				</span>
			</div>
		</div>
	</div>
{%- endmacro %}

{% macro ratingBlock(rating_value, overall_rating) -%}
	<css>

	</css>
	<div class="well well-tny info-item">
		<div class="row singleitem"  id="rating-container">
			<div class="col-md-3 rowTitle">
				Rating:
			</div>
			<div class="col-md-9 rowContents" id='rating'>

				<div class="box box-orange box-example-1to10">
					<div class="box-body">
						<div class="br-wrapper br-theme-bars-1to10">
							<div class="br-widget">
								<select id="item-rating" name="rating">
									<option value="">Unrated</option>
									<option value="1">1</option>
									<option value="2">2</option>
									<option value="3">3</option>
									<option value="4">4</option>
									<option value="5">5</option>
									<option value="6">6</option>
									<option value="7">7</option>
									<option value="8">8</option>
									<option value="9">9</option>
									<option value="10">10</option>
								</select>
							</div>
							<div class="br-widget">Average of {{series_rating['num']}} ratings. {{"You have not rated this series." if series_rating['user'] == -1 else "Your rating: %s" % series_rating['user'] | int}}</div>

						</div>
					</div>
				</div>

			</div>
		</div>
	</div>
{%- endmacro %}

{% macro multiItemLink(name, value, valId, width=3, extra_cls='') -%}
	<div class="well well-tny info-item">
		<div class="row singleitem"  id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
				<span class='text-nowrap'>
					<a id='editlink' href="#" onclick="edit('{{valId}}-container');return false;">[edit]</a>
					<a id='historylink' href="/history/{{valId}}/{{series.id}}">[history]</a>
				</span>
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
				{%- if value -%}
					{% set links = value.split('\n') %}

					<span class='singleitem {{extra_cls}}' style='display: none;'>{{ value }}</span>
					<span class='singleitem'>
						{% for linkurl in links %}
							<a href='{{linkurl}}'>{{ linkurl }}</a>{% if not loop.last %}<br>{% endif %}
						{% endfor %}
					</span>
				{%- else -%}
					<span class='singleitem {{extra_cls}}'>N/A</span>
				{%- endif -%}
			</div>
		</div>
	</div>
{%- endmacro %}


{% macro lastUpdateBlock(value, width=5, extra_cls='') -%}

	{% set staleness = staleness_factor(value) %}

	<div class="well well-tny info-item {{staleness}}">
		<div class="row singleitem">
			<div class="col-md-{{width}} rowTitle">
				Last Update:
			</div>
			<div class="col-md-{{12-width}} rowContents">
				{% if value %}
					{% if staleness == "updating-never" %}
						<span class='singleitem'>Never!</span>
					{% else %}
						<span class='singleitem'>{{ terse_ago(value) }} ago</span>
					{% endif %}
					{% if staleness == "updating-stale" %}
						<span style='float:right'>Possibly stalled!</span>
					{% endif %}
					{% if staleness == "updating-stalled" %}
						<span style='float:right'>Probably stalled or dropped!</span>
					{% endif %}
				{% else %}
					<span class='singleitem'>Never!</span>
				{% endif %}
			</div>
		</div>
	</div>
{%- endmacro %}


{% macro singleItemBlockDropbox(name, value, valId, values, width=3) -%}
	<div class="well well-tny info-item">
		<div class="row dropitem"  id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
				<span class='text-nowrap'>
					<a id='editlink' href="#" onclick="edit('{{valId}}-container');return false;">[edit]</a>
					<a id='historylink' href="/history/{{valId}}/{{series.id}}">[history]</a>
				</span>
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
				<div class='singleitem'>
					<span class='dropitem-text'>{{ values[value] | safe }}</span>
					<span class='dropitem-box' style='display: none; width:90%'>
						<select>
							{% for key, val in values.items() %}
								<option value='{{key}}' {{'selected="selected"' if key == value else ''}} >{{val}}</option>
							{% endfor %}
						</select>
					</span>
				</div>

			</div>
		</div>
	</div>
{%- endmacro %}

{% macro multiItemBlock(name, inList, itemKey, valId, link_base, width=3) -%}
	<div class="well well-tny info-item">
		<div class="row multiitem" id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
				<span class='text-nowrap'>
					<a id='editlink' href="#" onclick="edit('{{valId}}-container');return false;">[edit]</a>
					<a id='historylink' href="/history/{{valId}}/{{series.id}}">[history]</a>
				</span>
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
				{% for item in inList %}
					<span class='multiitem' id='{{valId}}'><a href="/{{link_base}}/{{item.id}}/">{{ item[itemKey] }}</a>{% if not loop.last %},{% endif %}</span>
				{% else %}
					<span class='multiitem' id='{{valId}}'>N/A</span>
				{% endfor %}

			</div>
		</div>
	</div>
{%- endmacro %}



{% macro multiItemList(name, inList, itemKey, valId, link_base, link=True, width=3) -%}
	<div class="well well-tny info-item">
		<div class="row multilist" id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
				<span class='text-nowrap'>
					<a id='editlink' href="#" onclick="edit('{{valId}}-container');return false;">[edit]</a>
					<a id='historylink' href="/history/{{valId}}/{{series.id}}">[history]</a>
				</span>
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
				<ul>
					{% for item in inList %}
					<li><span class='multilist' id='{{valId}}'>{{ item[itemKey] }}</span></li>
					{% endfor %}
					{% if not inList %}
						<span class='multilist' id='{{valId}}'></span>
					{% endif %}
				</ul>

			</div>
		</div>
	</div>
{%- endmacro %}

{% macro dateBlock(name, value, valId, width=3, extra_cls='') -%}
	<div class="well well-tny info-item">
		<div class="row dateitem"  id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
				<span class='text-nowrap'>
					<a id='editlink' href="#" onclick="edit('{{valId}}-container');return false;">[edit]</a>
					<a id='historylink' href="/history/{{valId}}/{{series.id}}">[history]</a>
				</span>
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
				<span class='singleitem {{extra_cls}}'>{{ ( value.date() if value else "N/A" ) | safe }}</span>
			</div>
		</div>
	</div>
{%- endmacro %}


{% macro mergeInto() -%}

	<div class="well well-tny info-item">
		<div class="row multilist" id="{{valId}}-container">
			<div class="col-md-12 rowContents" id='{{valId}}'>
				<form class="form-inline" action="javascript:merge_ajax();">

					<div class="col-md-3 rowTitle">
						<label style='margin-top:5px'>Merge into series ID</label>
					</div>
					<div class="col-md-9 rowTitle">
						<input type="text" class="form-control input-sm" id="dbid" placeholder="DbId">
						<button class="btn btn-primary btn-xs">Do Merge</button>
						<div class="pull-right" style='margin-top: 5px'>
							ID: {{series_id}}
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
{%- endmacro %}
{% macro dbAdminItem() -%}

	<div class="well well-tny info-item">
		<div class="row multilist" id="{{valId}}-container">
			<div class="col-md-12 rowContents" id='{{valId}}'>
				<form class="form-inline" action="javascript:merge_ajax();">

					<div class="col-md-3 rowTitle">
						<label style='margin-top:5px'>DB Admin View</label>
					</div>
					<div class="col-md-9 rowTitle">
						<a href="/db_admin/series/edit/?id={{series_id}}&url=%2Fdb_admin%2Fseries%2F">view</a>
					</div>
				</form>
			</div>
		</div>
	</div>
{%- endmacro %}

{% macro deleteItem() -%}

	<div class="well well-tny info-item">
		<div class="row multilist" id="{{valId}}-container">
			<div class="col-md-12 rowContents" id='{{valId}}'>
				<form class="form-inline" action="javascript:delete_ajax();">
					<div class="col-md-3 rowTitle">
						<label style='margin-top:5px'>Delete Series:</label>
					</div>
					<div class="col-md-9 rowTitle">
						<button style='margin-top:4px' class="btn btn-primary btn-xs">DO IT</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<div class="well well-tny info-item">
		<div class="row multilist" id="{{valId}}-container">
			<div class="col-md-12 rowContents" id='{{valId}}'>
				<form class="form-inline" action="javascript:delete_releases_ajax();">
					<div class="col-md-3 rowTitle">
						<label style='margin-top:5px'>Delete Auto-Releases:</label>
					</div>
					<div class="col-md-9 rowTitle">
						<button style='margin-top:4px' class="btn btn-primary btn-xs">DO IT</button>
					</div>
				</form>
			</div>
		</div>
	</div>
{%- endmacro %}

{% macro similarSeriesBlock(similar_series) -%}

		<a class='pull-right' href="/help#similar-series">
			<i class="glyphicon glyphicon-question-sign"></i>
		</a>
		<strong>Similar series</strong>

		{% if similar_series %}
			<ul>
				{% for item_name, item_id in similar_series %}
					<li>
						<a href="/series-id/{{item_id}}/">{{item_name}}</a>
					</li>
				{% endfor %}
			</ul>
		{% else %}
			<br>No results found! Does this series not have any tags?
		{% endif %}

{%- endmacro %}

{% macro coversBlock(series, covers) -%}

	{% if covers %}
		<div class='imgDiv'>
			{% for cover in covers %}
				<div id="cover-item" style="display: none;">
					<img class='coverimg' src='/cover-img/{{ cover.id }}'>
					{% if cover.description %}
						<h4>{{cover.description}}</h4>
					{% else %}
						<h5>No Description</h5>
					{% endif %}
				</div>
			{% endfor %}

			<p id='cover-offset' style=""></p>

			<div class='cvr-edit-div'>
				<a id='editlink' href="/series-id/{{ series.id }}/edit-covers/">[edit covers]</a>

			</div>
			{% if covers|length > 1 %}
				<div class='cvr-btn-div'>
					<button class="btn btn-default btn-prev" onclick="prev_cover();"><i class="glyphicon glyphicon-chevron-left"></i></button>
					<button class="btn btn-default btn-next" onclick="next_cover();"><i class="glyphicon glyphicon-chevron-right"></i></button>
				</div>
			{% endif %}

		</div>
	{% else %}
		<style>


			#x{
				position:relative;
				border-radius:2px;
			}
			#x::after,#x::before{
				position:absolute;
				left:0px;
				content:'';
				display:block;
				height:10px;
				background-color:red;

			}
			#x::after{
				-webkit-transform: rotate(45deg);
				-moz-transform: rotate(45deg);
				-ms-transform: rotate(45deg);
				-o-transform: rotate(45deg);
				transform: rotate(45deg);
			}
			#x::before{
				-webkit-transform: rotate(-45deg);
				-moz-transform: rotate(-45deg);
				-ms-transform: rotate(-45deg);
				-o-transform: rotate(-45deg);
				transform: rotate(-45deg);
			}
			#x-content {
				text-align: center !important ;
			}
			#x-desc-div {
				position: absolute;
				bottom: 0;
				margin-right:auto;
				margin-left:auto;
			}


		</style>
		<div class='imgDiv right-div' id='x'>
			<div id='x-desc-div'>
				<p id='x-content'>
					<a id='editlink' href="/series-id/{{ series.id }}/edit-covers/">No covers! Add one, maybe?</a>
				</p>
			</div>
		</div>
	{% endif %}

	<style>

			@media (min-width: 100px) {
				#x::after,#x::before
				{
					top:50px;
					width:100px;
				}
				#x-content
				{
					width: 100px;
				}

				.imgDiv
				{
					height     : 270px;
					width      : 100px;
				}
				.coverimg
				{
					max-height: 150px;
					max-width: 90px;
					vertical-align: top;
				}
			}
			@media (min-width: 275px) {
				#x::after,#x::before
				{
					top:100px;
					width:200px;
				}
				#x-content
				{
					width: 200px;
				}

				.imgDiv
				{
					height     : 370px;
					width      : 200px;
				}
				.coverimg
				{
					max-height: 270px;
					max-width: 190px;
					vertical-align: top;
				}
			}

			@media (min-width: 450px) {
				#x::after,#x::before
				{
					top:200px;
					width:400px;
				}
				#x-content
				{
					width: 400px;
				}

				.imgDiv
				{
					height     : 615px;
					width      : 400px;
				}
				.coverimg
				{
					max-width: 350px;
					max-height: 500px;
					vertical-align: top;
				}
			}


	</style>
{%- endmacro %}


{% macro watchBlock(watches, watchlists, progress, latest_dict) -%}


	<div class="well well-tny info-item" id="watch-root" data-vol="{{latest_dict['vol']}}" data-chp="{{latest_dict['chp']}}" data-frg="{{latest_dict['frg']}}">
		<div class="row singleitem" id="watch-container">
			<div style="display: inline-block; padding-left: 20px;">
				<div class="rowTitle" style='display: inline-block; min-width: 130px; vertical-align: top;'>
					In watch list:
					<span id='watch-state' class='text-nowrap light-grey'>
						[saved]
					</span>
				</div>
				<div class="rowContents" id='watch' style="display: inline-block; align-self: center;">
					<div style='display: inline-block; float: left;'>
						<select id='watch-list-select' class="list-select form-control" onchange="edit_watch('#watch-list-select');return false;">

							<option disabled>Current lists:</option>
							{% if watchlists %}
								{% for listname in watchlists %}
									{% if watches.listname == listname %}
										<option value='{{listname | safe}}' selected="selected">{{listname | safe}}</option>
									{% else %}
										<option value='{{listname | safe}}'>{{listname | safe}}</option>
									{% endif %}
								{% endfor %}
								<option disabled>──────────</option>
							{% endif %}
							<option value='new-list'>{{"<new list>" | e}}</option>
							{% if watches.listname %}
								<option value='-0-0-0-0-0-0-0-no-list-0-0-0-0-0-0-0-0-'>{{"<remove item>" | e}}</option>
							{% else %}
								<option selected="selected" value='-0-0-0-0-0-0-0-no-list-0-0-0-0-0-0-0-0-'>{{"<not watched>" | e}}</option>
							{% endif %}
						</select>
					</div>
				</div>
			</div>
			<div class="rowContents"  style="float: right; padding-right: 20px;">
				{% if watches and watchlists %}
					<div id='spinner-div' style='display: inline-block; float:right;'>
						<form class="form-inline">
							<div class="form-group form-group-sm btn-xs chap-btn">
								<label class="control-label-sm">Vol:</label>
								<input id="vol" class="form-control form-control-num" type="number" value="{{ (progress['vol'] | float |round(2)|string).rstrip('0').rstrip('.') }}" min="0" />
							</div>
							<div class="form-group form-group-sm btn-xs chap-btn">
								<label class="control-label-sm">Chapter:</label>
								<input id="chap" class="form-control form-control-num" type="number" value="{{ (progress['chp'] | float |round(2)|string).rstrip('0').rstrip('.') }}" min="0" />
							</div>
							<div class="form-group form-group-sm btn-xs chap-btn">
								<label class="control-label-sm">Fragment:</label>
								<input id="frag" class="form-control form-control-num" type="number" value="{{ (progress['frg'] | float |round(2)|string).rstrip('0').rstrip('.') }}" min="0" />
							</div>
						</form>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
{%- endmacro %}




{% macro localLinkBlock(name, value, valId, width=3, extra_cls='') -%}
	<div class="well well-tny info-item">
		<div class="row singleitem"  id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
				{%- if value -%}

					{% if g.user.id == 2 %}
						{% set links = value.split('\n') %}
						<span class='singleitem'>
							{% for linkurl in links %}
								<a href='http://10.1.1.60:5001/view?url={{linkurl | urlencode}}'>R-View - {{ linkurl }}</a>{% if not loop.last %}<br>{% endif %}
							{% endfor %}
						</span>

					{% else %}
						<a href='{{value}}'>{{ value }}</a>
					{% endif %}
				{%- else -%}
					<span class='singleitem {{extra_cls}}'>N/A</span>
				{%- endif -%}
			</div>
		</div>
	</div>
{%- endmacro %}

{% macro stagingLinkBlock(name, itemid, valId, width=3, extra_cls='') -%}
	<div class="well well-tny info-item">
		<div class="row singleitem"  id="{{valId}}-container">
			<div class="col-md-{{width}} rowTitle">
				{{ name }}:
			</div>
			<div class="col-md-{{12-width}} rowContents" id='{{valId}}'>
					<a href='http://10.1.1.59:5000/series-id/{{itemid}}/'>Test-View - {{ itemid }}</a>
			</div>
		</div>
	</div>
{%- endmacro %}

{% extends "__base.html" %}

{% block header %}


	<meta name="manga-id" content="{{ series_id }}">

{% endblock %}

{% block footer %}
	<script src="/static/js/editable.js"></script>
	<script src="/static/js/autogrow.js"></script>
	<script src="/static/js/bootstrap-number-input.js"></script>

	<link rel="stylesheet" type="text/css" href="/static/css/jquery.datetimepicker.css"/>
	<script src="/static/js/jquery.datetimepicker.js"></script>

	{% if g.user.is_mod() %}
		{% include '_block_admin_scripts.html' %}
	{% endif %}


	<script>
		$('#vol' ).bootstrapNumber();
		$('#vol' ).change(readChange);
		$('#chap').bootstrapNumber();
		$('#chap').change(readChange);
		$('#frag').bootstrapNumber();
		$('#frag').change(readChange);

		function merge_ajax()
		{
			console.log("Ready to send!");
			var merge_id  = $("#dbid").val();
			console.log("merge_id", merge_id)

			var mangaId  = $('meta[name=manga-id]').attr('content')
			var params = {
				'mode'      : 'merge-id',
				'item-id'   : mangaId,
				'merge_id'  : merge_id
			}


			$.ajax({
				url : "/api",
				success : saveCallback(false),
				data: JSON.stringify(params),
				method: "POST",
				dataType: 'json',
				contentType: "application/json;",
			});
		}


		// Hi there!
		// Yes, you can see the function. The API
		// endpoint it calls requires proper auth.
		// It's cute you're trying to mess things up, though....
		function delete_ajax()
		{
			console.log("Ready to send!");

			var mangaId  = $('meta[name=manga-id]').attr('content')
			var params = {
				'mode'      : 'delete-series',
				'item-id'   : mangaId,
			}

			bootbox.confirm("Really delete series ID " + mangaId + "?", function(result) {
				if (result != true)
					return;

				$.ajax({
					url : "/api",
					success : saveCallback(false),
					data: JSON.stringify(params),
					method: "POST",
					dataType: 'json',
					contentType: "application/json;",
				});
			});
		}

		function delete_releases_ajax()
		{
			console.log("Ready to send!");

			var mangaId  = $('meta[name=manga-id]').attr('content')
			var params = {
				'mode'      : 'delete-auto-releases',
				'item-id'   : mangaId,
			}

			bootbox.confirm("Really delete auto-sourced series release items for " + mangaId + "?", function(result) {
				if (result != true)
					return;

				$.ajax({
					url : "/api",
					success : saveCallback(false),
					data: JSON.stringify(params),
					method: "POST",
					dataType: 'json',
					contentType: "application/json;",
				});
			});
		}

		var i = 0;
		var pos_text = $('p[id="cover-offset"]');
		var divs = $('div[id="cover-item"]');
		if (divs.length == 1)
		{
			console.log("Divs:", divs)
			console.log("ThisDiv:", divs.eq(0))
			divs.eq(0).fadeIn(400);
		}
		else if (divs.length > 1)
		{
			divs.hide();

			divs.eq(i).fadeIn(400)
					  .delay(5000)
					  .fadeOut(400, cycle);
			pos_text.html("Cover " + (i+1) + " of " + divs.length);

			function cycle()
			{
				i = ++i % divs.length;
				divs.eq(i).fadeIn(400)
						  .delay(5000)
						  .fadeOut(400, cycle);


				pos_text.html("Cover " + (i+1) + " of " + divs.length);

			}


			function next_cover()
			{
				divs.each(function() {
					$(this).unbind();
					$(this).stop(true);
					$(this).hide();
				})

				i = ++i % divs.length;
				divs.eq(i).show();
				pos_text.html("Cover " + (i+1) + " of " + divs.length);


			}
			function prev_cover()
			{
				divs.each(function() {
					$(this).unbind();
					$(this).stop(true);
					$(this).hide();
				})

				i = --i
				if (i < 0)
					i = divs.length-1;

				divs.eq(i).show();
				pos_text.html("Cover " + (i+1) + " of " + divs.length);

			}

		}
		else
		{
			// No images?
		}


		function update_read_div_color()
		{
			// console.log("Wat?");
			var root = $("#watch-root");
			// console.log(root);

			var a_vol = root.data('vol');
			var a_chp = root.data('chp');
			var a_frg = root.data('frg');

			var c_vol  = $("#vol").val();
			var c_chp  = $("#chap").val();
			var c_frg = $("#frag").val();

			agg_a = Number(a_vol) * 1e3 + Number(a_chp) + Number(a_frg) / 100.0;
			agg_c = Number(c_vol) * 1e3 + Number(c_chp) + Number(c_frg) / 100.0;

			if (agg_a > agg_c)       // More available then read
				root.removeClass("reading-ahead").removeClass("reading-current").addClass("reading-behind");
			else if (agg_a < agg_c)  // Reading ahead of what's available.
				root.removeClass("reading-current").removeClass("reading-behind").addClass("reading-ahead");
			else if (agg_a = agg_c)  // Up to date
				root.removeClass("reading-ahead").removeClass("reading-behind").addClass("reading-current");
			else  // Vals are NaN, item isn't watched. Remove all classes
			{
				root.removeClass("reading-ahead").removeClass("reading-behind").removeClass("reading-current");
			}

		}
		$('#vol' ).change(update_read_div_color);
		$('#chap').change(update_read_div_color);
		$('#frag').change(update_read_div_color);

		function set_rating(value, text)
		{
			console.log("Updating rating to " + value);
			value = parseInt(value);
			var manga_id = $('meta[name=manga-id]').attr('content')

			var params = {
				'mode'      : 'set-rating',
				'item-id'   : manga_id,
				'rating'    : value,
			}


			$.ajax({
				url : "/api",
				success : saveCallback(false),
				data: JSON.stringify(params),
				method: "POST",
				dataType: 'json',
				contentType: "application/json;",
			});
			// alert('Selected rating: ' + value);
		}

		update_read_div_color();

		// Plop in the jquery star rating plugin.
		// This is easier (and probably faster) then loading ANOTHER external script.
		// Source: http://antenna.io/demo/jquery-bar-rating/examples/
		!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):t(jQuery)}(function(t){var e=function(){function e(){var e=this,a=function(){var a=[e.options.wrapperClass];""!==e.options.theme&&a.push("br-theme-"+e.options.theme),e.$elem.wrap(t("<div />",{"class":a.join(" ")}))},n=function(){e.$elem.unwrap()},r=function(){var a;return a=e.options.initialRating?t('option[value="'+e.options.initialRating+'"]',e.$elem):t("option:selected",e.$elem)},i=function(){var t=r();e.$elem.data("barrating",{userOptions:e.options,currentRatingValue:t.val(),currentRatingText:t.data("html")?t.data("html"):t.text(),originalRatingValue:t.val(),originalRatingText:t.data("html")?t.data("html"):t.text()}),e.$elem.data("barrating").deselectable=e.$elem.find("option:first").val()?!1:!0},s=function(){e.$elem.removeData("barrating")},l=function(){var a=t("<div />",{"class":"br-widget"});return e.$elem.find("option").each(function(){var n,r,i,s,l;n=t(this).val(),n&&(r=t(this).text(),i=t(this).data("html"),i&&(r=i),s=t("<a />",{href:"#","data-rating-value":n,"data-rating-text":r}),l=t("<span />",{html:e.options.showValues?r:""}),a.append(s.append(l)))}),e.options.showSelectedRating&&a.append(t("<div />",{text:"","class":"br-current-rating"})),e.options.reverse&&a.addClass("br-reverse"),e.options.readonly&&a.addClass("br-readonly"),a},o=function(){return e.options.reverse?"nextAll":"prevAll"},u=function(t){e.$elem.find('option[value="'+t+'"]').prop("selected",!0),e.$elem.change()},c=function(t){t=t?t:e.$elem.data("barrating").currentRatingText,e.options.showSelectedRating&&e.$elem.parent().find(".br-current-rating").text(t)},d=function(t){t.find("a").removeClass("br-selected br-current"),t.find('a[data-rating-value="'+e.$elem.data("barrating").currentRatingValue+'"]').addClass("br-selected br-current")[o()]().addClass("br-selected")},g=function(a){a.on("click",function(n){var r,i,s=t(this);return n.preventDefault(),a.removeClass("br-active br-selected"),s.addClass("br-selected")[o()]().addClass("br-selected"),r=s.attr("data-rating-value"),i=s.attr("data-rating-text"),s.hasClass("br-current")&&e.$elem.data("barrating").deselectable?(s.removeClass("br-selected br-current")[o()]().removeClass("br-selected br-current"),r="",i=""):(a.removeClass("br-current"),s.addClass("br-current")),e.$elem.data("barrating").currentRatingValue=r,e.$elem.data("barrating").currentRatingText=i,u(r),c(i),e.options.onSelect.call(this,e.$elem.data("barrating").currentRatingValue,e.$elem.data("barrating").currentRatingText),!1})},h=function(e){e.on({mouseenter:function(){var a=t(this);e.removeClass("br-active br-selected"),a.addClass("br-active")[o()]().addClass("br-active"),c(a.attr("data-rating-text"))}})},f=function(t,e){e.on({mouseleave:function(){t.removeClass("br-active"),c(),d(e)}})},m=function(e){e.on("touchstart",function(e){e.preventDefault(),e.stopPropagation(),t(this).click()})},b=function(t){t.on("click",function(t){t.preventDefault()})};this.show=function(){var t,n;e.$elem.data("barrating")||(a(),i(),t=l(),t.insertAfter(e.$elem),d(t),c(),n=t.find("a"),e.options.fastClicks&&m(n),e.options.readonly?b(n):(g(n),e.options.hoverState&&(h(n),f(n,t))),e.$elem.hide())},this.set=function(t){this.$elem.find('option[value="'+t+'"]').val()&&(this.$elem.data("barrating").currentRatingValue=t,this.$elem.data("barrating").currentRatingText=this.$elem.find('option[value="'+t+'"]').text(),u(this.$elem.data("barrating").currentRatingValue),c(this.$elem.data("barrating").currentRatingText),d(this.$widget),this.$elem.data("barrating").userOptions.onSelect.call(this,this.$elem.data("barrating").currentRatingValue,this.$elem.data("barrating").currentRatingText))},this.clear=function(){this.$elem.data("barrating").currentRatingValue=this.$elem.data("barrating").originalRatingValue,this.$elem.data("barrating").currentRatingText=this.$elem.data("barrating").originalRatingText,u(this.$elem.data("barrating").currentRatingValue),c(this.$elem.data("barrating").currentRatingText),d(this.$widget),this.$elem.data("barrating").userOptions.onClear.call(this,this.$elem.data("barrating").currentRatingValue,this.$elem.data("barrating").currentRatingText)},this.destroy=function(){var t=this.$elem.data("barrating").currentRatingValue,e=this.$elem.data("barrating").currentRatingText,a=this.$elem.data("barrating").userOptions;this.$widget.off().remove(),s(),n(),this.$elem.show(),a.onDestroy.call(this,t,e)}}return e.prototype.init=function(e,a){return this.$elem=t(a),this.options=t.extend({},t.fn.barrating.defaults,e),this.options},e}();t.fn.barrating=function(a,n){return this.each(function(){var r=new e;if(t(this).is("select")||t.error("Sorry, this plugin only works with select fields."),r.hasOwnProperty(a)){if(r.init(n,this),"show"===a)return r.show(n);if(r.$elem.data("barrating"))return r.$widget=t(this).next(".br-widget"),r[a](n)}else{if("object"==typeof a||!a)return n=a,r.init(n,this),r.show();t.error("Method "+a+" does not exist on jQuery.barrating")}})},t.fn.barrating.defaults={theme:"",initialRating:null,showValues:!1,showSelectedRating:!0,reverse:!1,readonly:!1,fastClicks:!0,hoverState:!0,wrapperClass:"br-wrapper",onSelect:function(t,e){},onClear:function(t,e){},onDestroy:function(t,e){}},t.fn.barrating.BarRating=e});

			$(function() {
				$('#item-rating').barrating({
					initialRating : {{"null" if series_rating['avg'] == -1 else series_rating['avg'] | int}},
					onSelect      : set_rating
					// theme: 'fontawesome-stars'
				});
			});

	</script>
	<style>
		.br-widget
		{
			display: block;
			clear  :both;
		}
		.br-theme-bars-1to10 .br-widget a
		{
			display: block;
			width: 16px;
			padding: 5px 0;
			height: 28px;
			float: left;
			background-color: #bbcefb;
			margin: 1px;
			text-align: center;
		}
		.br-theme-bars-1to10 .br-widget a.br-active,
		.br-theme-bars-1to10 .br-widget a.br-selected
		{
			background-color: #4278f5;
		}
		.br-theme-bars-1to10 .br-widget .br-current-rating
		{
			font-size: 20px;
			/*line-height: 2;*/
			float: left;
			padding: 0 20px 0 20px;
			color: #4278f5;
			font-weight: 400;
		}
		@media print
		{
			.br-theme-bars-1to10 .br-widget a
			{
				border: 1px solid #b3b3b3;
				background: white;
				height: 38px;
				-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
				box-sizing: border-box;
			}
			.br-theme-bars-1to10 .br-widget a.br-active,
			.br-theme-bars-1to10 .br-widget a.br-selected
			{
				border: 1px solid black;
				background: white;
			}
			.br-theme-bars-1to10 .br-widget .br-current-rating
			{
				color: black;
			}
		}
	</style>

{% endblock %}


{% block content %}
	{% include '_block_flash.html' %}


	<div>
		<h2>{{ series.title }}</h2>
			{{watchBlock(watch, watchlists, progress, latest_dict)}}
			<div class='right-div'>
				{{coversBlock(series, series.covers)}}
				{{similarSeriesBlock(similar_series)}}
			</div>

			{{singleItemBlock("Description",
								series.description,
								'description',
								extra_cls='description'
							)
			}}



			{{
				ratingBlock(1.5, 2.5)
			}}

			{{
				singleItemNonEditable("People watching", total_watches)
			}}

			{{singleItemBlockDropbox("OEL/Translated",
								series.tl_type,
								'tl_type',
								{
									"oel"        : "OEL",
									"translated" : "Translated",
								},
								width=5
							)
			}}

			{{singleItemBlock("Demographic",
								series.demographic,
								'demographic',
								width=5
							)
			}}

			{{singleItemBlockDropbox("Type",
								series.type,
								'type',
								{
									"Novel"       : "Novel",
									"Light-Novel" : "Light-Novel",
									"Web-Novel"   : "Web-Novel",
								},
								width=5
							)
			}}



			{% if series.tl_type == 'translated' %}

				{{singleItemBlockDropbox("Country of Origin",
									series.origin_loc,
									'origin_loc',
									{
										"unknown" : "Unknown",
										"china"   : "China",
										"japan"   : "Japan",
										"korea"   : "Korea",
									},
									width=5
								)
				}}

				{{singleItemBlock("Status in Country of Origin",
									series.orig_status,
									'orig_status',
									width=5
								)
				}}

				{{singleItemBlock("Original Language",
									series.orig_lang,
									'orig_lang',
									width=5
								)
				}}

				{{singleItemBlockDropbox("General Type",
									series.region,
									'region',
									{
										"eastern" : "Eastern",
										"western" : "Western",
										"unknown" : "Unknown",
									},
									width=5
								)
				}}

				{% if series.license_en == True %}
					{% set lic_state = 'True'%}
				{% elif series.license_en == False %}
					{% set lic_state = 'False'%}
				{% else %}
					{% set lic_state = 'unknown'%}
				{% endif %}
				{{singleItemBlockDropbox("Licensed (in english)",
									lic_state,
									'license_en',
									{
										"unknown" : "Unknown",
										"True"    : "Yes",
										"False"   : "No",
									},
									width=5
								)
				}}
			{% endif %}

			{{multiItemBlock("Author(s)",
							series.author,
								'name',
								'author',
								'author-id',
								width=5
							)
			}}

			{% if series.tl_type == 'translated' %}
				{{multiItemBlock("Illustrator(s)",
									series.illustrators,
									'name',
									'illustrators',
									'artist-id',
									width=5
								)
				}}

				{{multiItemBlock("Publisher(s)",
								series.publishers,
									'name',
									'publisher',
									'publishers',
									width=5
								)
				}}

				{{dateBlock("Initial publish date",
									series.pub_date,
									'pub_date',
									width=5
								)
				}}
			{% endif %}


			{{multiItemBlock("Tags",
								series.tags,
								'tag',
								'tag',
								'tag-id',
								width=5
							)
			}}
			{{multiItemBlock("Genres",
								series.genres,
								'genre',
								'genre',
								'genre-id',
								width=5
							)
			}}

			{{lastUpdateBlock(most_recent)}}

			{{multiItemList("Alternate Names",
								series.alternatenames,
								'name',
								'altnames',
								'altnames-id',
								width=5
							)
			}}

			{{multiItemLink("Homepage",
								series.website,
								'website',
								width=5
							)
			}}


			{% if g.user.is_mod() %}
				<hr class='padded-rule'>

				{{singleItemBlock("Change Title",
									series.title,
									'title'
								)
				}}

				{% if g.user.id == 2 %}

					{{localLinkBlock("Homepage",
									series.website,
									'website',
									width=5
								)
					}}
					{{stagingLinkBlock("Test-Site",
									series.id,
									'staging',
									width=5
								)
					}}
					{{dbAdminItem()}}
				{% endif %}


				{{mergeInto()}}
				{{deleteItem()}}
			{% endif %}
			<div style="clear: both;"></div>
			<hr class='padded-rule'>

	</div>


	{% set release_items = releases %}
	<div>
		<div style='float:right'>
			<sup>Releases found: {{ release_items | length }}</sup>

			<p>
				<a href='/add/release/{{series.id}}/'>Add a release</a>
			</p>
		</div>
		<span>
			<h3 >Series Releases: </h3>
			<h5 >Latest release - {{latest_str}}</h5>
		</span>
		{% include '_block_releases.html' %}
	</div>

	</ul>
{% endblock %}
